var fish;(fish=fish||{}).util={},fish.util.Vector=function(t,e){this.x=t,this.y=e,this.add=t=>{this.x+=t.x,this.y+=t.y},this.wrap=t=>{this.x=this.x<0?t.x-Math.abs(this.x%t.x):this.x%t.x,this.y=this.y<0?t.y-Math.abs(this.y%t.y):this.y%t.y}},fish.util.Rect=class{constructor(t,e,i,r){this.pos=new fish.util.Vector(t,e),this.size=new fish.util.Vector(i,r)}get x(){return this.pos.x}get y(){return this.pos.y}get w(){return this.size.x}get h(){return this.size.y}get r(){return this.pos.x+this.size.x}get b(){return this.pos.y+this.size.y}},fish.util.loadText=async function(t){return await new Promise((e,i)=>{let r=new XMLHttpRequest;r.onreadystatechange=function(){4==this.readyState&&(200==this.status?e(this.responseText):i(`couldn't get file '${t}', response code ${this.status}`))},r.open("GET",t,!0),r.send()})},(fish=fish||{}).graphics={},fish.graphics.Texture=function(t,e,i){this.getGlTexture=()=>t,this.getWidth=()=>e,this.getHeight=()=>i},fish.graphics.Atlas=function(){let t={};this.add=(e,i)=>{t[e]=i},this.get=t=>t in this.sprites?this.sprites[t]:(console.error("unknown sprite name "+t),new fish.util.Rect(0,0,0,0)),this.n=()=>Object.keys(t).length,this.forEach=e=>{for(let i in t)e(i,t[i])}},fish.graphics.Colour=function(t=1,e=1,i=1,r=1){this.r=t,this.g=e,this.b=i,this.a=r},fish.graphics.loadTexture=async function(t,e){return await new Promise((i,r)=>{const s=new Image;s.onload=()=>{const e=t.createTexture();t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),i(new fish.graphics.Texture(e,s.width,s.height))},s.onerror=()=>{r("failed loading image "+e)},s.src=e})},fish.graphics.loadAtlas=async function(t){let e=await fish.util.loadText(t);if(null==e)return null;let i=JSON.parse(e),r=new fish.graphics.Atlas;for(let t in i){let e=i[t];r.add(t,new fish.util.Rect(e.x,e.y,e.w,e.h))}return r},fish.graphics.Patch=class{constructor(t,e){let i=t.w-2*e,r=t.h-2*e;if(i<1||r<1)throw`${e} is too wide a border for ${t.w},${t.h}`;fish.util.Rect(t.x,t.y,e,e),fish.util.Rect(t.x+e,t.y,i,e),fish.util.Rect(t.x+e+i,t.y,e,e),fish.util.Rect(t.x,t.y+e,e,r),fish.util.Rect(t.x+e,t.y+e,i,r),fish.util.Rect(t.x+e+i,t.y+e,e,r),fish.util.Rect(t.x,t.y+e+r,e,e),fish.util.Rect(t.x+e,t.y+e+r,i,e),fish.util.Rect(t.x+e+i,t.y+e+r,e,e)}get tl(){return tl}get t(){return t}get tr(){return tr}get ml(){return ml}get m(){return m}get mr(){return mr}get bl(){return bl}get b(){return b}get br(){return br}get border(){return border}},fish.graphics.SpriteRenderer=function(t){t.disable(t.DEPTH_TEST),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.width=t.canvas.clientWidth,this.height=t.canvas.clientHeight,this.Batch=function(e,i){let r=new Float32Array(12*i),s=new Float32Array(12*i),n=0,a=!1;const o=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,r,t.DYNAMIC_DRAW);const h=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,h),t.bufferData(t.ARRAY_BUFFER,s,t.DYNAMIC_DRAW),this.add=(t,e)=>{if(n>=i)return;const a=12*n;r[a]=e.x,r[a+1]=e.y,r[a+2]=e.r,r[a+3]=e.y,r[a+4]=e.x,r[a+5]=e.b,r[a+6]=e.r,r[a+7]=e.y,r[a+8]=e.r,r[a+9]=e.b,r[a+10]=e.x,r[a+11]=e.b,s[a]=t.x,s[a+1]=t.b,s[a+2]=t.r,s[a+3]=t.b,s[a+4]=t.x,s[a+5]=t.y,s[a+6]=t.r,s[a+7]=t.b,s[a+8]=t.r,s[a+9]=t.y,s[a+10]=t.x,s[a+11]=t.y,n++},this.addPatch=(t,e)=>{new fish.util.Rect(0,0,0,0);this.add(t.tl,new fish.util.Rect(e.x,e.y,t.border,t.border)),this.add(t.t,new fish.util.Rect(e.x+t.border,e.y,e.w-2*t.border,t.border)),this.add(t.tr,new fish.util.Rect(e.x+e.w-t.border,e.y,t.border,t.border)),this.add(t.ml,new fish.util.Rect(e.x,e.y+t.border,t.border,t.border)),this.add(t.m,new fish.util.Rect(e.x+t.border,e.y+t.border,e.w-2*t.border,t.border)),this.add(t.mr,new fish.util.Rect(e.x+e.w-t.border,e.y+t.border,t.border,t.border)),this.add(t.bl,new fish.util.Rect(e.x,e.y+e.h-t.border,t.border,t.border)),this.add(t.b,new fish.util.Rect(e.x+t.border,e.y+e.h-t.border,e.w-2*t.border,t.border)),this.add(t.br,new fish.util.Rect(e.x+e.w-t.border,e.y+e.h-t.border,t.border,t.border))},this.clear=()=>{a=!1,n=0},this.render=()=>{if(a)return void console.error("repeat batch rendering without clear");a=!0;let i=fish.shader.bindDefaultShader(t);t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferSubData(t.ARRAY_BUFFER,0,r),t.vertexAttribPointer(i.position,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(i.position),t.bindBuffer(t.ARRAY_BUFFER,h),t.bufferSubData(t.ARRAY_BUFFER,0,s),t.vertexAttribPointer(i.textureCoord,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(i.textureCoord),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e.getGlTexture()),t.uniform1i(i.sampler,0),t.uniform2f(i.invTextureSize,1/e.getWidth(),1/e.getHeight()),t.drawArrays(t.TRIANGLES,0,6*n)}},this.loadTexture=async function(e){return await fish.graphics.loadTexture(t,e)},this.clear=(e=1,i=1,r=1,s=1)=>{t.clearColor(e,i,r,s),t.clear(t.COLOR_BUFFER_BIT)},this.clearColour=t=>{this.clear(t.r,t.g,t.b,t.a)}},fish.graphics.BLACK=new fish.graphics.Colour(0,0,0,1),fish.graphics.WHITE=new fish.graphics.Colour(1,1,1,1),fish.graphics.RED=new fish.graphics.Colour(1,0,0,1),fish.graphics.GREEN=new fish.graphics.Colour(0,1,0,1),fish.graphics.BLUE=new fish.graphics.Colour(0,0,1,1),(fish=fish||{}).audio={},fish.audio.Sample=function(t,e){this.name=t,this.buffer=e},fish.audio.BasicAudio=function(t,e=3){let i=t.createBufferSource(),r=t.createBufferSource();i.connect(t.destination),r.connect(t.destination);let s="",n="",a=[],o=0,h=function(){let e=t.createBufferSource();e.connect(t.destination);let i=!1,r=0;this.isPlaying=()=>i,this.getStart=()=>r,this.getPriority=()=>0,this.play=(t,s)=>{i=!0,r=o,t=t,s=s,e.buffer=t.buffer,e.start(0),e.onended=()=>{i=!1}},this.same=t=>i&&t&&t.name==this.sample.name,this.lesser=(t,e)=>!i||0<t||0==t&&r<e};for(let t=0;t<e;t++)a.push(new h);this.update=()=>{o++},this.playSample=(t,e=0)=>{let i=-1,r=-99999,s=0;for(let e=0;e<a.length;e++){if(a[e].same(t)&&a[e].getStart()==o)return;a[e].lesser(r,s)&&(i=e,r=a[e].getPriority(),s=a[e].getStart())}i>=0&&a[i].play(t,e)},this.playSong=t=>{s!=t.name&&(s=t.name,i.buffer=t.buffer,i.start(0))},this.loadSong=async function(t,e){let i=await t.getSample(e);i&&this.playSong(i)},this.playNoise=t=>{n!=t.name&&(n=t.name,r.buffer=t.buffer,r.start(0))},this.loadNoise=async function(t,e){let i=await t.getSample(e);i&&this.playSong(i)},this.loadSample=async function(e){let i=new XMLHttpRequest;return i.open("GET",e,!0),i.responseType="arraybuffer",new Promise((r,s)=>{i.onload=()=>{t.decodeAudioData(i.response,t=>{r(new fish.audio.Sample(e,t))},()=>{s("Couldn't load sample "+e)})},i.send()})}},(fish=fish||{}).input={},fish.input.UI_UP="UI_UP",fish.input.UI_DOWN="UI_DOWN",fish.input.UI_LEFT="UI_LEFT",fish.input.UI_RIGHT="UI_RIGHT",fish.input.UI_ACCEPT="UI_ACCEPT",fish.input.UI_CANCEL="UI_CANCEL",fish.input.BasicInput=function(t={},e=.9){t.UP||(t.UP="ArrowUp"),t.DOWN||(t.DOWN="ArrowDown"),t.LEFT||(t.LEFT="ArrowLeft"),t.RIGHT||(t.RIGHT="ArrowRight"),t.A||(t.A="Shift"),t.B||(t.B="z"),t.X||(t.X="a"),t.Y||(t.Y="x"),t.L||(t.L="d"),t.R||(t.R="c"),t.SELECT||(t.SELECT="Escape"),t.START||(t.START="Enter");let i=0,r={},s={UP:!1,DOWN:!1,LEFT:!1,RIGHT:!1,X:!1,Y:!1,A:!1,B:!1,L:!1,R:!1,SELECT:!1,START:!1};this.UP="UP",this.DOWN="DOWN",this.LEFT="LEFT",this.RIGHT="RIGHT",this.X="X",this.Y="Y",this.A="A",this.B="B",this.L="L",this.R="R",this.SELECT="SELECT",this.START="START",document.addEventListener("keydown",t=>{r[t.key]=!0}),document.addEventListener("keyup",t=>{r[t.key]=!1});let n=function(t){return"object"==typeof t?t.pressed:1==t},a=function(t,e,r=!1){r&&(e=e||s[t]>0),e?0==s[t]&&(s[t]=i):s[t]=0},o=t=>{switch(t){case fish.input.UI_UP:return this.UP;case fish.input.UI_DOWN:return this.DOWN;case fish.input.UI_LEFT:return this.LEFT;case fish.input.UI_RIGHT:return this.RIGHT;case fish.input.UI_ACCEPT:return this.A;case fish.input.UI_CANCEL:return this.B}return null};this.update=function(){i++;let s=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];a(this.A,r[t.A]),a(this.B,r[t.B]),a(this.X,r[t.X]),a(this.Y,r[t.Y]),a(this.L,r[t.L]),a(this.R,r[t.R]),a(this.SELECT,r[t.SELECT]),a(this.START,r[t.START]),a(this.UP,r[t.UP]),a(this.DOWN,r[t.DOWN]),a(this.LEFT,r[t.LEFT]),a(this.RIGHT,r[t.RIGHT]);for(let t of s)a(this.A,n(t.buttons[0]),!0),a(this.B,n(t.buttons[1]),!0),a(this.X,n(t.buttons[2]),!0),a(this.Y,n(t.buttons[3]),!0),a(this.L,n(t.buttons[4]),!0),a(this.R,n(t.buttons[5]),!0),a(this.SELECT,n(t.buttons[8]),!0),a(this.START,n(t.buttons[9]),!0),a(this.UP,n(t.buttons[12])||t.axes[1]<-e,!0),a(this.DOWN,n(t.buttons[13])||t.axes[1]>e,!0),a(this.LEFT,n(t.buttons[14])||t.axes[0]<-e,!0),a(this.RIGHT,n(t.buttons[15])||t.axes[0]>e,!0)},this.down=function(t){if(!(t in s))throw t;return s[t]>0},this.justDown=function(t){if(!(t in s))throw t;return s[t]==i},this.uiDown=t=>this.down(o(t)),this.uiJustDown=t=>this.justDown(o(t))},(fish=fish||{}).Store=function(t,e,i){let r={},s={texture:t.loadTexture,atlas:fish.graphics.loadAtlas,sample:e.loadSample},n=async function(t,e){if(!(t in r))if(e in s){let n=await s[e](i+t);null==n&&console.error(`loading ${i}${t} failed`),r[t]=n}else console.error(e+" is a not a valid asset type"),r[t]=null;return r[t]};this.getTexture=async function(t){return await n(t,"texture")},this.getAtlas=async function(t){return await n(t,"atlas")},this.getSample=async function(t){return await n(t,"sample")}},(fish=fish||{}).shader=(()=>{let t=null,e={loadShader:(t,e,i)=>{const r=t.createShader(e);return t.shaderSource(r,i),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(console.error("Could not compiler shader: "+t.getShaderInfoLog(r)),null)},createShaderProgram:(t,i=null,r=null)=>{const s=e.loadShader(t,t.VERTEX_SHADER,i||"\n    attribute vec4 position;\n    attribute vec4 textureCoord;\n    uniform vec4 invCanvas;\n    uniform vec2 invTextureSize;\n    varying highp vec2 vTextureCoord;\n    void main() {\n        gl_Position = position * (invCanvas * vec4(2, 2, 1.0, 1.0)) - vec4(1.0, 1.0, 0, 0);\n        vTextureCoord = textureCoord.xy * invTextureSize;\n    }"),n=e.loadShader(t,t.FRAGMENT_SHADER,r||"\n    uniform sampler2D sampler;\n    varying highp vec2 vTextureCoord;\n    void main() {\n        gl_FragColor = texture2D(sampler, vTextureCoord);\n    }"),a=t.createProgram();if(t.attachShader(a,s),t.attachShader(a,n),t.linkProgram(a),!t.getProgramParameter(a,t.LINK_STATUS))return console.error("Could not init shader program: "+t.getProgramInfoLog(a)),null;const o=t.canvas.clientWidth,h=t.canvas.clientHeight;t.useProgram(a);const u=t.getUniformLocation(a,"invCanvas");return t.uniform4f(u,1/o,1/h,1,1),{program:a,position:t.getAttribLocation(a,"position"),textureCoord:t.getAttribLocation(a,"textureCoord"),invTextureSize:t.getUniformLocation(a,"invTextureSize"),invCanvas:u,sampler:t.getUniformLocation(a,"sampler")}},bindDefaultShader:i=>(null==t&&(t=e.createShaderProgram(i)),i.useProgram(t.program),t)};return e})(),(fish=fish||{}).screen={},fish.screen.Screen=function(t,e,i,r,s){this.refresh=t,this.input=e,this.update=i,this.render=r,this.evaluate=s},fish.screen.DullScreen=function(t,e,i){fish.screen.Screen.call(this,t,t=>!0,e,i,()=>null)},fish.screen.LoadScreen=function(t,e,...i){Promise.all(i).then(t=>{},t=>{}),fish.screen.DullScreen.call(this,()=>{},()=>{},()=>{t.clearf(Math.random(),Math.random(),math.random(),1)})},(fish=fish||{}).start=async function(t,e,i,r,s,n){let a={graphics:e,audio:i,input:r,store:s},o=await n(a);if(null==o)return void console.err("No Starting Screen. Game Cannot Start.");let h=[o];o.refresh();const u=(t=null)=>{const e=h[h.length-1].update.next(t);if(e.done){const t=h[h.length-1].evaluate();h.pop(),h.length>0&&(h[h.length-1].refresh(),u(t))}e.value&&(h.push(e.value),h[h.length-1].refresh())};setInterval(()=>{if(h.length>0)for(o of(a.audio.update(),a.input.update(),u(),e.clear(0,0,0,1),h))o.render(e)},20)},fish.normalStart=async function(t,e,i,r,s){let n=new fish.graphics.SpriteRenderer(e),a=new fish.audio.BasicAudio(i);await fish.start(t,n,a,new fish.input.BasicInput,new fish.Store(n,a,r),s)};