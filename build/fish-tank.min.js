class Colour{constructor(e,r,t,n){this.r=e,this.g=r,this.b=t,this.a=n}}class Vector{constructor(e,r){this.x=e,this.y=r}add(e){this.x+=e.x,this.y+=e.y}wrap(e){this.x=this.x<0?e.x-Math.abs(this.x%e.x):this.x%e.x,this.y=this.y<0?e.y-Math.abs(this.y%e.y):this.y%e.y}}class Rect{constructor(e,r,t,n){this.pos=new Vector(e,r),this.size=new Vector(t,n)}get x(){return this.pos.x}get y(){return this.pos.y}get w(){return this.size.x}get h(){return this.size.y}get r(){return this.pos.x+this.size.x}get b(){return this.pos.y+this.size.y}}class Texture{constructor(e,r,t){this.glTexture=e,this.width=r,this.height=t}}async function loadTexture(e,r){return await new Promise((t,n)=>{const a=new Image;a.onload=()=>{const r=e.createTexture();e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,a),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),t(new Texture(r,a.width,a.height))},a.src=r})}const defaultVertexShader="\nattribute vec4 position;\nattribute vec4 textureCoord;\nuniform vec4 invCanvas;\nuniform vec2 invTextureSize;\nvarying highp vec2 vTextureCoord;\nvoid main() {\n    gl_Position = position * (invCanvas * vec4(2, 2, 1.0, 1.0)) - vec4(1.0, 1.0, 0, 0);\n    vTextureCoord = textureCoord.xy * invTextureSize;\n}",defaultFragmentShader="\nuniform sampler2D sampler;\nvarying highp vec2 vTextureCoord;\nvoid main() {\n    gl_FragColor = texture2D(sampler, vTextureCoord);\n}";let defaultShader=null;function loadShader(e,r,t){const n=e.createShader(r);return e.shaderSource(n,t),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS)?n:(console.error("Could not compiler shader: "+e.getShaderInfoLog(n)),null)}function createShaderProgram(e,r=null,t=null){const n=loadShader(e,e.VERTEX_SHADER,r||defaultVertexShader),a=loadShader(e,e.FRAGMENT_SHADER,t||defaultFragmentShader),o=e.createProgram();if(e.attachShader(o,n),e.attachShader(o,a),e.linkProgram(o),!e.getProgramParameter(o,e.LINK_STATUS))return console.error("Could not init shader program: "+e.getProgramInfoLog(o)),null;const i=e.canvas.clientWidth,s=e.canvas.clientHeight;e.useProgram(o);const u=e.getUniformLocation(o,"invCanvas");return e.uniform4f(u,1/i,1/s,1,1),{program:o,position:e.getAttribLocation(o,"position"),textureCoord:e.getAttribLocation(o,"textureCoord"),invTextureSize:e.getUniformLocation(o,"invTextureSize"),invCanvas:u,sampler:e.getUniformLocation(o,"sampler")}}function bindDefaultShader(e){return null==defaultShader&&(defaultShader=createShaderProgram(e)),e.useProgram(defaultShader.program),defaultShader}function createBatch(e,r,t){let n=new Float32Array(12*t),a=new Float32Array(12*t),o=0,i=!1;const s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,n,e.DYNAMIC_DRAW);const u=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,u),e.bufferData(e.ARRAY_BUFFER,a,e.DYNAMIC_DRAW),{add:(e,r)=>{if(o>=t)return;const i=12*o;n[i]=r.x,n[i+1]=r.y,n[i+2]=r.r,n[i+3]=r.y,n[i+4]=r.x,n[i+5]=r.b,n[i+6]=r.r,n[i+7]=r.y,n[i+8]=r.r,n[i+9]=r.b,n[i+10]=r.x,n[i+11]=r.b,a[i]=e.x,a[i+1]=e.y,a[i+2]=e.r,a[i+3]=e.y,a[i+4]=e.x,a[i+5]=e.b,a[i+6]=e.r,a[i+7]=e.y,a[i+8]=e.r,a[i+9]=e.b,a[i+10]=e.x,a[i+11]=e.b,o++},clear:()=>{i=!1,o=0},render:()=>{if(i)return void console.error("repeat batch rendering without clear");i=!0;let t=bindDefaultShader(e);e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferSubData(e.ARRAY_BUFFER,0,n),e.vertexAttribPointer(t.position,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(t.position),e.bindBuffer(e.ARRAY_BUFFER,u),e.bufferSubData(e.ARRAY_BUFFER,0,a),e.vertexAttribPointer(t.textureCoord,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(t.textureCoord),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,r.glTexture),e.uniform1i(t.sampler,0),e.uniform2f(t.invTextureSize,1/r.width,1/r.height),e.drawArrays(e.TRIANGLES,0,6*o)}}}function createScreen(e,r,t,n){return{input:e,update:r,render:t,evaluate:n}}function createDullScreen(e,r){return createScreen(e=>!0,e,r,()=>null)}function createLoadScreen(e,...r){let t=null;return Promise.all(r).then(r=>{t=e(...r)}),createDullScreen(function*(){for(;!t;)yield;return t}(),(e,r,t,n,a)=>{e.clearColor(Math.random(),Math.random(),Math.random(),1),e.clear(e.COLOR_BUFFER_BIT)})}function start(e,r){const t=e.canvas.clientWidth,n=e.canvas.clientHeight;screens=[r];const a=(e=null)=>{const r=screens[screens.length-1].update.next(e);if(r.done){const e=screens[screens.length-1].evaluate();screens.pop(),screens.length>0&&a(e)}r.value&&screens.push(r.value)};e.disable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),setInterval(()=>{if(screens.length>0)for(r of(a(),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT),screens))r.render(e,0,0,t,n)},20)}