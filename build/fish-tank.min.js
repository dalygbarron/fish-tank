var fish;(fish=fish||{}).util={},fish.util.Vector=function(t=0,e=0){this.x=t,this.y=e,this.set=(t=0,e=0)=>{this.x=t,this.y=e},this.add=(t,e=1)=>{this.x+=t.x*e,this.y+=t.y*e},this.wrap=t=>{this.x=this.x<0?t.x-Math.abs(this.x%t.x):this.x%t.x,this.y=this.y<0?t.y-Math.abs(this.y%t.y):this.y%t.y}},fish.util.Rect=class{constructor(t=0,e=0,i=0,s=0){this.pos=new fish.util.Vector(t,e),this.size=new fish.util.Vector(i,s)}copy(){return new fish.util.Rect(this.x,this.y,this.w,this.h)}shrink(t){this.pos.x+=t,this.pos.y+=t,this.size.x-=2*t,this.size.y-=2*t}get x(){return this.pos.x}get y(){return this.pos.y}get w(){return this.size.x}get h(){return this.size.y}get r(){return this.pos.x+this.size.x}get t(){return this.pos.y+this.size.y}},fish.util.loadText=async function(t){return await new Promise((e,i)=>{let s=new XMLHttpRequest;s.onreadystatechange=function(){4==this.readyState&&(200==this.status?e(this.responseText):i(`couldn't get file '${t}', response code ${this.status}`))},s.open("GET",t,!0),s.send()})},fish.util.fitText=(t,e,i)=>{console.log(i);let s="",r=t.split(/\n\n+/);for(let t of r){let r=0,n=t.split(/\s/);for(let t of n){if(0==t.length)continue;let n=(t.length-1)*e.getHorizontalPadding();for(let i=0;i<t.length;i++)n+=e.getWidth(t.charAt(i));r+n>i?(s+="\n"+t,r=n):(s+=t,r+=n),r+=e.getWidth(" "),s+=" "}s+="\n"}return s},fish.util.textHeight=(t,e)=>{let i=t.split(/\n(?=\S+)/).length;return i*e.getLineHeight()+(i-1)*e.getVerticalPadding()},fish.util.aRect=new fish.util.Rect,(fish=fish||{}).graphics={},fish.graphics.Texture=function(t,e,i){this.getGlTexture=()=>t,this.getWidth=()=>e,this.getHeight=()=>i},fish.graphics.Atlas=function(){let t={};this.add=(e,i)=>{t[e]=i},this.get=e=>e in t?t[e]:(console.error("unknown sprite name "+e),new fish.util.Rect(0,0,0,0)),this.getPatch=(t,e=0)=>{let i=this.get(t);if(e<=0){let i=t.match(/\d+/);if(!i)throw new Error("fish.graphics.Atlas.getPatch requires a border number or a sprite with a name that ends with a number");e=parseInt(i[0])}return new fish.graphics.Patch(i,e)},this.n=()=>Object.keys(t).length,this.forEach=e=>{for(let i in t)e(i,t[i])}},fish.graphics.Colour=function(t=1,e=1,i=1,s=1){this.r=t,this.g=e,this.b=i,this.a=s},fish.graphics.BitmapFont=class{constructor(t){this.sprite=t}getHorizontalPadding(){return 0}getVerticalPadding(){return 0}getWidth(t){return this.sprite.w/16}getLineHeight(){return this.sprite.h/16}},fish.graphics.loadTexture=async function(t,e){return await new Promise((i,s)=>{const r=new Image;r.onload=()=>{const e=t.createTexture();t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),i(new fish.graphics.Texture(e,r.width,r.height))},r.onerror=()=>{s("failed loading image "+e)},r.src=e})},fish.graphics.loadAtlas=async function(t){let e=await fish.util.loadText(t);if(null==e)return null;let i=JSON.parse(e),s=new fish.graphics.Atlas;for(let t in i){let e=i[t];s.add(t,new fish.util.Rect(e.x,e.y,e.width,e.height))}return s},fish.graphics.Patch=class{constructor(t,e){let i=t.w-2*e,s=t.h-2*e;if(i<1||s<1)throw`${e} is too wide a border for ${t.w},${t.h}`;this.BORDER=e,this.TL=new fish.util.Rect(t.x,t.y,e,e),this.T=new fish.util.Rect(t.x+e,t.y,i,e),this.TR=new fish.util.Rect(t.x+e+i,t.y,e,e),this.ML=new fish.util.Rect(t.x,t.y+e,e,s),this.M=new fish.util.Rect(t.x+e,t.y+e,i,s),this.MR=new fish.util.Rect(t.x+e+i,t.y+e,e,s),this.BL=new fish.util.Rect(t.x,t.y+e+s,e,e),this.B=new fish.util.Rect(t.x+e,t.y+e+s,i,e),this.BR=new fish.util.Rect(t.x+e+i,t.y+e+s,e,e)}},fish.graphics.PatchRenderer=class{renderPatch(t,e){throw new Error("fish.graphics.PatchRenderer.renderPatch must be implemented")}renderText(t,e,i){throw new Error("fish.graphics.PatchRenderer.renderText must be implemented")}},fish.graphics.SpriteRenderer=function(t){new fish.util.Rect;t.disable(t.DEPTH_TEST),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.width=t.drawingBufferWidth,this.height=t.drawingBufferHeight,console.log(this.width,this.height),this.Batch=function(e,i){let s=new Float32Array(12*i),r=new Float32Array(12*i),n=0,h=!1;const o=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,s,t.DYNAMIC_DRAW);const a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,r,t.DYNAMIC_DRAW),this.addComp=(t,e,h,o,a)=>{if(n>=i)return;const l=12*n;s[l]=e,s[l+1]=h,s[l+2]=o,s[l+3]=h,s[l+4]=e,s[l+5]=a,s[l+6]=o,s[l+7]=h,s[l+8]=o,s[l+9]=a,s[l+10]=e,s[l+11]=a,r[l]=t.x,r[l+1]=t.t,r[l+2]=t.r,r[l+3]=t.t,r[l+4]=t.x,r[l+5]=t.y,r[l+6]=t.r,r[l+7]=t.t,r[l+8]=t.r,r[l+9]=t.y,r[l+10]=t.x,r[l+11]=t.y,n++},this.add=(t,e,i=1)=>{let s,r,n,h;if(e instanceof fish.util.Rect)s=e.x,r=e.r,h=e.y,n=e.t;else{if(!(e instanceof fish.util.Vector))throw new TypeError("SpriteRenderer.Batch.add requres a Vector or a Rect");{let o=.5*i;s=e.x-t.w*o,r=e.x+t.w*o,h=e.y+t.h*o,n=e.y-t.h*o}}this.addComp(t,s,n,r,h)},this.addPatch=(t,e)=>{this.addComp(t.BL,e.x,e.y,e.x+t.BORDER,e.y+t.BORDER),this.addComp(t.B,e.x+t.BORDER,e.y,e.r-t.BORDER,e.y+t.BORDER),this.addComp(t.BR,e.r-t.BORDER,e.y,e.r,e.y+t.BORDER),this.addComp(t.ML,e.x,e.y+t.BORDER,e.x+t.BORDER,e.t-t.BORDER),this.addComp(t.M,e.x+t.BORDER,e.y+t.BORDER,e.r-t.BORDER,e.t-t.BORDER),this.addComp(t.MR,e.r-t.BORDER,e.y+t.BORDER,e.r,e.t-t.BORDER),this.addComp(t.TL,e.x,e.t-t.BORDER,e.x+t.BORDER,e.t),this.addComp(t.T,e.x+t.BORDER,e.t-t.BORDER,e.r-t.BORDER,e.t),this.addComp(t.TR,e.r-t.BORDER,e.t-t.BORDER,e.r,e.t)},this.addText=(t,e,i)=>{let s=t.getWidth("n"),r=t.getLineHeight(),n=0,h=0;fish.util.aRect.size.set(s,r);for(let o=0;o<e.length;o++){let a=e.charCodeAt(o);10==a?(h+=r+t.getVerticalPadding(),n=0):(fish.util.aRect.pos.set(t.sprite.x+Math.floor(a%16)*s,t.sprite.y+Math.floor(a/16)*r),this.addComp(fish.util.aRect,i.x+n,i.y-h-r,i.x+n+s,i.y-h),n+=s+t.getHorizontalPadding())}},this.renderPatch=(t,e)=>{this.addPatch(t,e)},this.renderText=(t,e,i)=>{this.addText(t,e,i)},this.clear=()=>{h=!1,n=0},this.render=()=>{if(h)return void console.error("repeat batch rendering without clear");h=!0;let i=fish.shader.bindDefaultShader(t);t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferSubData(t.ARRAY_BUFFER,0,s),t.vertexAttribPointer(i.position,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(i.position),t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferSubData(t.ARRAY_BUFFER,0,r),t.vertexAttribPointer(i.textureCoord,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(i.textureCoord),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e.getGlTexture()),t.uniform1i(i.sampler,0),t.uniform2f(i.invTextureSize,1/e.getWidth(),1/e.getHeight()),t.drawArrays(t.TRIANGLES,0,6*n)}},this.loadTexture=async function(e){return await fish.graphics.loadTexture(t,e)},this.clear=(e=1,i=1,s=1,r=1)=>{t.clearColor(e,i,s,r),t.clear(t.COLOR_BUFFER_BIT)},this.clearColour=t=>{this.clear(t.r,t.g,t.b,t.a)}},fish.graphics.BLACK=new fish.graphics.Colour(0,0,0,1),fish.graphics.WHITE=new fish.graphics.Colour(1,1,1,1),fish.graphics.RED=new fish.graphics.Colour(1,0,0,1),fish.graphics.GREEN=new fish.graphics.Colour(0,1,0,1),fish.graphics.BLUE=new fish.graphics.Colour(0,0,1,1),(fish=fish||{}).audio={},fish.audio.Sample=function(t,e){this.name=t,this.buffer=e},fish.audio.BasicAudio=function(t,e=3){let i=t.createBufferSource(),s=t.createBufferSource();i.connect(t.destination),s.connect(t.destination);let r="",n="",h=[],o=0,a=function(){let e=t.createBufferSource();e.connect(t.destination);let i=!1,s=0;this.isPlaying=()=>i,this.getStart=()=>s,this.getPriority=()=>0,this.play=(t,r)=>{i=!0,s=o,t=t,r=r,e.buffer=t.buffer,e.start(0),e.onended=()=>{i=!1}},this.same=t=>i&&null,this.lesser=(t,e)=>!i||0<t||0==t&&s<e};for(let t=0;t<e;t++)h.push(new a);this.update=()=>{o++},this.playSample=(t,e=0)=>{let i=-1,s=-99999,r=0;for(let e=0;e<h.length;e++){if(h[e].same(t)&&h[e].getStart()==o)return;h[e].lesser(s,r)&&(i=e,s=h[e].getPriority(),r=h[e].getStart())}i>=0&&h[i].play(t,e)},this.playSong=t=>{r!=t.name&&(r=t.name,i.buffer=t.buffer,i.start(0))},this.loadSong=async function(t,e){let i=await t.getSample(e);i&&this.playSong(i)},this.playNoise=t=>{n!=t.name&&(n=t.name,s.buffer=t.buffer,s.start(0))},this.loadNoise=async function(t,e){let i=await t.getSample(e);i&&this.playSong(i)},this.loadSample=async function(e){let i=new XMLHttpRequest;return i.open("GET",e,!0),i.responseType="arraybuffer",new Promise((s,r)=>{i.onload=()=>{t.decodeAudioData(i.response,t=>{s(new fish.audio.Sample(e,t))},()=>{r("Couldn't load sample "+e)})},i.send()})}},(fish=fish||{}).input={},fish.input.UI_BUTTON={UP:"UP",DOWN:"DOWN",LEFT:"LEFT",RIGHT:"RIGHT",ACCEPT:"ACCEPT",CANCEL:"CANCEL"},fish.input.UiInput=class{uiDown(t){throw new Error("fish.input.UiInput.uiDown must be implemented")}uiJustDown(t){throw new Error("fish.input.UiInput.uiJustDown must be implemented")}},fish.input.BasicInput=function(t={},e=.9){this.BUTTON={UP:"UP",DOWN:"DOWN",LEFT:"LEFT",RIGHT:"RIGHT",X:"X",Y:"Y",A:"A",B:"B",L:"L",R:"R",SELECT:"SELECT",START:"START"},t.UP||(t.UP="ArrowUp"),t.DOWN||(t.DOWN="ArrowDown"),t.LEFT||(t.LEFT="ArrowLeft"),t.RIGHT||(t.RIGHT="ArrowRight"),t.A||(t.A="Shift"),t.B||(t.B="z"),t.X||(t.X="a"),t.Y||(t.Y="x"),t.L||(t.L="d"),t.R||(t.R="c"),t.SELECT||(t.SELECT="Escape"),t.START||(t.START="Enter");let i=0,s={},r={};for(let t in this.BUTTON)r[t]=0;document.addEventListener("keydown",t=>{s[t.key]=!0}),document.addEventListener("keyup",t=>{s[t.key]=!1});let n=t=>"object"==typeof t?t.pressed:1==t,h=(t,e,s=!1)=>{s&&(e=e||r[t]>0),e?0==r[t]&&(r[t]=i):r[t]=0},o=t=>{switch(t){case fish.input.UI_BUTTON.UP:return this.BUTTON.UP;case fish.input.UI_BUTTON.DOWN:return this.BUTTON.DOWN;case fish.input.UI_BUTTON.LEFT:return this.BUTTON.LEFT;case fish.input.UI_BUTTON.RIGHT:return this.BUTTON.RIGHT;case fish.input.UI_BUTTON.ACCEPT:return this.BUTTON.A;case fish.input.UI_BUTTON.CANCEL:return this.BUTTON.B}throw t};this.update=()=>{i++;let e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];for(let e in this.BUTTON)h(e,s[t[e]]);for(let t of e)h(this.BUTTON.A,n(t.buttons[0]),!0),h(this.BUTTON.B,n(t.buttons[1]),!0),h(this.BUTTON.X,n(t.buttons[2]),!0),h(this.BUTTON.Y,n(t.buttons[3]),!0),h(this.BUTTON.L,n(t.buttons[4]),!0),h(this.BUTTON.R,n(t.buttons[5]),!0),h(this.BUTTON.SELECT,n(t.buttons[8]),!0),h(this.BUTTON.START,n(t.buttons[9]),!0),h(this.BUTTON.UP,n(t.buttons[12])||t.axes[1]<-threshold,!0),h(this.BUTTON.DOWN,n(t.buttons[13])||t.axes[1]>threshold,!0),h(this.BUTTON.LEFT,n(t.buttons[14])||t.axes[0]<-threshold,!0),h(this.BUTTON.RIGHT,n(t.buttons[15])||t.axes[0]>threshold,!0)},this.down=t=>{if(!(t in r))throw t;return r[t]>0},this.justDown=t=>{if(!(t in r))throw t;return r[t]==i},this.uiDown=t=>this.down(o(t)),this.uiJustDown=t=>this.justDown(o(t))},(fish=fish||{}).gui={},fish.gui.Knob=class{constructor(t){this.fitted=!1,this.bounds=null,this.style=t}selectable(){return!1}fit(t,e=!0){this.bounds=t,this.fitted=!0}update(t,e){return null}render(t,e){throw new Error("fish.gui.knob.render must be implemented")}},fish.gui.ContainerKnob=class extends fish.gui.Knob{constructor(t,e){super(t),this.hasSelectable=!1,this.selection=0,this.children=[];for(let t of e)this.addChild(t)}selectable(){return this.hasSelectable}incrementSelection(t){if(0==t||!this.hasSelectable)return;let e=Math.sign(t);for(let t=0;t<this.children.length&&0!=e;t++)this.selection+=e,this.selection<0&&(this.selection=this.children.length-1),this.selection>=this.children.length&&(this.selection=0),this.children[this.selection].selectable()&&(e=0)}addChild(t){this.children.push(t),t.selectable()&&!this.hasSelectable&&(this.hasSelectable=!0,this.selection=this.children.length-1)}},fish.gui.PanelKnob=class extends fish.gui.ContainerKnob{constructor(t,e=!1,i=[]){super(t,i),this.cancellable=e}fit(t,e=!0){let i=t.copy();i.shrink(this.style.panel.BORDER);for(let t in this.children)this.children[t].fit(i.copy(),t==this.children.length-1&&e),i.size.y-=this.children[t].bounds.h;e?super.fit(t):super.fit(new fish.util.Rect(t.x,t.y+i.h,t.w,t.h-i.h))}update(t,e){return this.cancellable&&t.uiDown(fish.input.UI_BUTTON.CANCEL)||0==this.children.length?null:(t.uiJustDown(fish.input.UI_BUTTON.UP)?this.incrementSelection(-1):t.uiJustDown(fish.input.UI_BUTTON.DOWN)&&this.incrementSelection(1),this.children[this.selection].update(t,e))}render(t,e){t.renderPatch(this.style.panel,this.bounds);for(let i in this.children)this.children[i].render(t,e&&i==this.selection)}},fish.gui.TextKnob=class extends fish.gui.Knob{constructor(t,e){super(t),this.text=e,this.fittedText="",this.origin=new fish.util.Vector}fit(t,e=!0){this.origin.x=t.x+1,this.origin.y=t.t-1,this.fittedText=fish.util.fitText(this.text,this.style.font,t.w-2);let i=fish.util.textHeight(this.fittedText,this.style.font)+2;t.pos.y+=t.size.y-i,t.size.y=i,super.fit(t)}render(t,e){t.renderText(this.style.font,this.fittedText,this.origin)}},fish.gui.ButtonKnob=class extends fish.gui.Knob{constructor(t,e,i=null){super(t),this.down=!1,this.result=i,this.child="string"==typeof e?new fish.gui.TextKnob(t,e):e}selectable(){return!0}fit(t,e=!0){let i=t.copy();i.shrink(this.style.button.BORDER),this.child.fit(i),e||(t.size.y=this.child.bounds.size.y+2*this.style.button.BORDER,t.pos.y=this.child.bounds.pos.y-this.style.button.BORDER),super.fit(t)}update(t,e){return t.uiDown(fish.input.UI_BUTTON.ACCEPT)&&!this.down?(e.playSample(this.style.click),this.down=!0,"function"==typeof this.result?this.result():this.result):null}render(t,e){t.renderPatch(e?this.style.buttonSelected:this.style.button,this.bounds),this.child.render(t,e)}},fish.gui.PicKnob=class extends fish.gui.Knob{constructor(t,e,i=1,s=!1){super(t),this.sprite=e,this.scale=i,this.stretch=s}},fish.gui.HBoxKnob=class extends fish.gui.ContainerKnob{constructor(t,e=[]){super(t,e)}fit(t,e=!0){let i=t.copy(),s=0;i.size.x/=this.children.length;for(let t of this.children)t.fit(i.copy(),e),i.pos.x+=i.size.x,s=Math.max(s,t.bounds.size.y);e||(t.size.y=s),super.fit(t,e)}update(t,e){return 0==this.children.length?null:(t.uiJustDown(fish.input.UI_BUTTON.LEFT)?this.incrementSelection(-1):t.uiJustDown(fish.input.UI_BUTTON.RIGHT)&&this.incrementSelection(1),this.children[this.selection].update(t,e))}render(t,e){for(let i in this.children)this.children[i].render(t,e&&i==this.selection)}},(fish=fish||{}).Store=function(t,e,i){let s={},r={texture:t.loadTexture,atlas:fish.graphics.loadAtlas,sample:e.loadSample},n=async function(t,e){if(!(t in s))if(e in r){let n=await r[e](i+t);s[t]=n}else console.error(e+" is a not a valid asset type"),s[t]=null;return s[t]};this.getTexture=async function(t){return await n(t,"texture")},this.getAtlas=async function(t){return await n(t,"atlas")},this.getSample=async function(t){return await n(t,"sample")}},(fish=fish||{}).shader=(()=>{let t=null,e={loadShader:(t,e,i)=>{const s=t.createShader(e);return t.shaderSource(s,i),t.compileShader(s),t.getShaderParameter(s,t.COMPILE_STATUS)?s:(console.error("Could not compiler shader: "+t.getShaderInfoLog(s)),null)},createShaderProgram:(t,i=null,s=null)=>{const r=e.loadShader(t,t.VERTEX_SHADER,i||"\n    attribute vec4 position;\n    attribute vec4 textureCoord;\n    uniform vec4 invCanvas;\n    uniform vec2 invTextureSize;\n    varying highp vec2 vTextureCoord;\n    void main() {\n        gl_Position = position * (invCanvas * vec4(2, 2, 1.0, 1.0)) - vec4(1.0, 1.0, 0, 0);\n        vTextureCoord = textureCoord.xy * invTextureSize;\n    }"),n=e.loadShader(t,t.FRAGMENT_SHADER,s||"\n    uniform sampler2D sampler;\n    varying highp vec2 vTextureCoord;\n    void main() {\n        gl_FragColor = texture2D(sampler, vTextureCoord);\n    }"),h=t.createProgram();if(t.attachShader(h,r),t.attachShader(h,n),t.linkProgram(h),!t.getProgramParameter(h,t.LINK_STATUS))return console.error("Could not init shader program: "+t.getProgramInfoLog(h)),null;const o=t.drawingBufferWidth,a=t.drawingBufferHeight;t.useProgram(h);const l=t.getUniformLocation(h,"invCanvas");return t.uniform4f(l,1/o,1/a,1,1),{program:h,position:t.getAttribLocation(h,"position"),textureCoord:t.getAttribLocation(h,"textureCoord"),invTextureSize:t.getUniformLocation(h,"invTextureSize"),invCanvas:l,sampler:t.getUniformLocation(h,"sampler")}},bindDefaultShader:i=>(null==t&&(t=e.createShaderProgram(i)),i.useProgram(t.program),t)};return e})(),(fish=fish||{}).screen={},fish.screen.Transition=class{constructor(t,e=null,i=null){this.pop=t,this.screen=e,this.message=i}},fish.screen.Screen=class{constructor(t){this.ctx=t}refresh(t){}update(t){return null}render(t){}},(fish=fish||{}).start=async function(t,e,i,s,r,n){const h=1/t;let o={gfx:e,snd:i,in:s,str:r},a=await n(o);if(null==a)return void console.err("No Starting Screen. Game Cannot Start.");let l=[a];a.refresh();setInterval(()=>{if(l.length>0)for(a of(o.snd.update(),o.in.update(),(()=>{const t=l[l.length-1].update(h);t&&(t.pop&&l.pop(),t.screen&&l.push(t.screen),l[l.length-1].refresh(t.message))})(),o.gfx.clear(0,0,0,1),l))a.render()},h)},fish.normalStart=async function(t,e,i,s,r){let n=new fish.graphics.SpriteRenderer(e),h=new fish.audio.BasicAudio(i);await fish.start(t,n,h,new fish.input.BasicInput,new fish.Store(n,h,s),r)};